# Lifetime

<aside>
ğŸ’¡

åªæœ‰å‡ºç°å¼•ç”¨æ‰ä¼šæ¶‰åŠç”Ÿå‘½å‘¨æœŸé—®é¢˜

ç”Ÿå‘½å‘¨æœŸæ ‡æ³¨å¹¶ä¸ä¼šæ”¹å˜ä»»ä½•å¼•ç”¨çš„å®é™…ä½œç”¨åŸŸ--é²è¿…

</aside>

ä¸€ä¸ªç”Ÿå‘½å‘¨æœŸæ ‡æ³¨ï¼Œå®ƒè‡ªèº«å¹¶ä¸å…·æœ‰ä»€ä¹ˆæ„ä¹‰ï¼Œå› ä¸ºç”Ÿå‘½å‘¨æœŸçš„ä½œç”¨å°±æ˜¯å‘Šè¯‰ç¼–è¯‘å™¨å¤šä¸ªå¼•ç”¨ä¹‹é—´çš„å…³ç³»ã€‚

```rust
fn useless<'a>(first: &'a i32, second: &'a i32) -> &'a i32{}
```

è¿™é‡Œçš„`'a`è¡¨ç¤ºï¼šè¿™ä¸¤ä¸ªå‚æ•°`first`å’Œ`second`**è‡³å°‘**æ´»å¾—å’Œ`'a`ä¸€æ ·ä¹…ï¼Œè‡³äºåˆ°åº•æ´»å¤šä¹…æˆ–è€…å“ªä¸ªæ´»å¾—æ›´ä¹…ä¸€ç‚¹ï¼Œä¸å¾—è€ŒçŸ¥ã€‚å¹¶ä¸”è¿”å›å€¼çš„ç”Ÿå‘½å‘¨æœŸä¹Ÿæ˜¯`'a`ã€‚

ä¹Ÿå°±æ˜¯è¯´ï¼Œ`'a`æ˜¯ä¸¤ä¸ªå‚æ•°ç”Ÿå‘½å‘¨æœŸçš„**äº¤é›†ã€‚**

**å‡½æ•°çš„è¿”å›å€¼å¦‚æœæ˜¯ä¸€ä¸ªå¼•ç”¨ç±»å‹ï¼Œé‚£ä¹ˆå®ƒçš„ç”Ÿå‘½å‘¨æœŸåªä¼šæ¥æºäº**ï¼š

- å‡½æ•°å‚æ•°çš„ç”Ÿå‘½å‘¨æœŸ
- å‡½æ•°ä½“ä¸­æŸä¸ªæ–°å»ºå¼•ç”¨çš„ç”Ÿå‘½å‘¨æœŸï¼ˆå…¸å‹çš„æ‚¬å‚å¼•ç”¨ï¼‰

```rust
fn longest<'a>(x: &str, y: &str) -> &'a str {
    let result = String::from("really long string");
    result.as_str()
}

error[E0515]: cannot return value referencing local variable `result` // è¿”å›å€¼resultå¼•ç”¨äº†æœ¬åœ°çš„å˜é‡
  --> src/main.rs:11:5
   |
11 |     result.as_str()
   |     ------^^^^^^^^^
   |     |
   |     returns a value referencing data owned by the current function
   |     `result` is borrowed here

```

å› ä¸º`result`åœ¨å‡½æ•°ç»“æŸåè¢«é‡Šæ”¾ï¼Œä½†æ˜¯å¯¹ä»–çš„å¼•ç”¨ä¾ç„¶åœ¨ç»§ç»­ã€‚

è§£å†³æ–¹æ³•ï¼šè¿”å›å†…éƒ¨å˜é‡çš„æ‰€æœ‰æƒï¼Œå°†æ‰€æœ‰æƒè½¬ç§»ç»™è°ƒç”¨è€…ã€‚

```rust
fn longest(_x: &str, _y: &str) -> String {
    String::from("really long string")
}

fn main() {
   let s = longest("not", "important");
}
```

ç”Ÿå‘½å‘¨æœŸæ¶ˆé™¤è§„åˆ™ï¼š

1. **æ¯ä¸€ä¸ªå¼•ç”¨å‚æ•°éƒ½ä¼šè·å¾—ç‹¬è‡ªçš„ç”Ÿå‘½å‘¨æœŸ**
    
    ä¾‹å¦‚ä¸€ä¸ªå¼•ç”¨å‚æ•°çš„å‡½æ•°å°±æœ‰ä¸€ä¸ªç”Ÿå‘½å‘¨æœŸæ ‡æ³¨:Â `fn foo<'a>(x: &'a i32)`ï¼Œä¸¤ä¸ªå¼•ç”¨å‚æ•°çš„æœ‰ä¸¤ä¸ªç”Ÿå‘½å‘¨æœŸæ ‡æ³¨:`fn foo<'a, 'b>(x: &'a i32, y: &'b i32)`,ä¾æ­¤ç±»æ¨ã€‚
    
2. **è‹¥åªæœ‰ä¸€ä¸ªè¾“å…¥ç”Ÿå‘½å‘¨æœŸï¼ˆå‡½æ•°å‚æ•°ä¸­åªæœ‰ä¸€ä¸ªå¼•ç”¨ç±»å‹ï¼‰ï¼Œé‚£ä¹ˆè¯¥ç”Ÿå‘½å‘¨æœŸä¼šè¢«èµ‹ç»™æ‰€æœ‰çš„è¾“å‡ºç”Ÿå‘½å‘¨æœŸ**ï¼Œä¹Ÿå°±æ˜¯æ‰€æœ‰è¿”å›å€¼çš„ç”Ÿå‘½å‘¨æœŸéƒ½ç­‰äºè¯¥è¾“å…¥ç”Ÿå‘½å‘¨æœŸ
    
    ä¾‹å¦‚å‡½æ•°Â `fn foo(x: &i32) -> &i32`ï¼Œ`x`Â å‚æ•°çš„ç”Ÿå‘½å‘¨æœŸä¼šè¢«è‡ªåŠ¨èµ‹ç»™è¿”å›å€¼Â `&i32`ï¼Œå› æ­¤è¯¥å‡½æ•°ç­‰åŒäºÂ `fn foo<'a>(x: &'a i32) -> &'a i32`
    
3. **è‹¥å­˜åœ¨å¤šä¸ªè¾“å…¥ç”Ÿå‘½å‘¨æœŸï¼Œä¸”å…¶ä¸­ä¸€ä¸ªæ˜¯Â `&self`Â æˆ–Â `&mut self`ï¼Œåˆ™Â `&self`Â çš„ç”Ÿå‘½å‘¨æœŸè¢«èµ‹ç»™æ‰€æœ‰çš„è¾“å‡ºç”Ÿå‘½å‘¨æœŸ**
    
    æ‹¥æœ‰Â `&self`Â å½¢å¼çš„å‚æ•°ï¼Œè¯´æ˜è¯¥å‡½æ•°æ˜¯ä¸€ä¸ªÂ `æ–¹æ³•`ï¼Œè¯¥è§„åˆ™è®©æ–¹æ³•çš„ä½¿ç”¨ä¾¿åˆ©åº¦å¤§å¹…æå‡ã€‚
    

`&'static`Â å¯¹äºç”Ÿå‘½å‘¨æœŸæœ‰ç€éå¸¸å¼ºçš„è¦æ±‚ï¼šä¸€ä¸ªå¼•ç”¨å¿…é¡»è¦æ´»å¾—è·Ÿå‰©ä¸‹çš„ç¨‹åºä¸€æ ·ä¹…ï¼Œæ‰èƒ½è¢«æ ‡æ³¨ä¸ºÂ `&'static`ã€‚
ä½†æ˜¯ï¼Œ**`&'static`Â ç”Ÿå‘½å‘¨æœŸé’ˆå¯¹çš„ä»…ä»…æ˜¯å¼•ç”¨ï¼Œè€Œä¸æ˜¯æŒæœ‰è¯¥å¼•ç”¨çš„å˜é‡ï¼Œå¯¹äºå˜é‡æ¥è¯´ï¼Œè¿˜æ˜¯è¦éµå¾ªç›¸åº”çš„ä½œç”¨åŸŸè§„åˆ™**:

```rust
use std::{slice::from_raw_parts, str::from_utf8_unchecked};

fn get_memory_location() -> (usize, usize) {
  // â€œHello Worldâ€ æ˜¯å­—ç¬¦ä¸²å­—é¢é‡ï¼Œå› æ­¤å®ƒçš„ç”Ÿå‘½å‘¨æœŸæ˜¯ `'static`.
  // ä½†æŒæœ‰å®ƒçš„å˜é‡ `string` çš„ç”Ÿå‘½å‘¨æœŸå°±ä¸ä¸€æ ·äº†ï¼Œå®ƒå®Œå…¨å–å†³äºå˜é‡ä½œç”¨åŸŸï¼Œå¯¹äºè¯¥ä¾‹å­æ¥è¯´ï¼Œä¹Ÿå°±æ˜¯å½“å‰çš„å‡½æ•°èŒƒå›´
  let string = "Hello World!";
  let pointer = string.as_ptr() as usize;
  let length = string.len();
  (pointer, length)
  // `string` åœ¨è¿™é‡Œè¢« drop é‡Šæ”¾
  // è™½ç„¶å˜é‡è¢«é‡Šæ”¾ï¼Œæ— æ³•å†è¢«è®¿é—®ï¼Œä½†æ˜¯æ•°æ®ä¾ç„¶è¿˜ä¼šç»§ç»­å­˜æ´»
}

fn get_str_at_location(pointer: usize, length: usize) -> &'static str {
  // ä½¿ç”¨è£¸æŒ‡é’ˆéœ€è¦ `unsafe{}` è¯­å¥å—
  unsafe { from_utf8_unchecked(from_raw_parts(pointer as *const u8, length)) }
}

fn main() {
  let (pointer, length) = get_memory_location();
  let message = get_str_at_location(pointer, length);
  println!(
    "The {} bytes at 0x{:X} stored: {}",
    length, pointer, message
  );
  // å¦‚æœå¤§å®¶æƒ³çŸ¥é“ä¸ºä½•å¤„ç†è£¸æŒ‡é’ˆéœ€è¦ `unsafe`ï¼Œå¯ä»¥è¯•ç€åæ³¨é‡Šä»¥ä¸‹ä»£ç 
  // let message = get_str_at_location(1000, 10);
}
```

é¢ä»£ç æœ‰ä¸¤ç‚¹å€¼å¾—æ³¨æ„ï¼š

- `&'static`Â çš„å¼•ç”¨ç¡®å®å¯ä»¥å’Œç¨‹åºæ´»å¾—ä¸€æ ·ä¹…ï¼Œå› ä¸ºæˆ‘ä»¬é€šè¿‡Â `get_str_at_location`Â å‡½æ•°ç›´æ¥å–åˆ°äº†å¯¹åº”çš„å­—ç¬¦ä¸²
- æŒæœ‰Â `&'static`Â å¼•ç”¨çš„å˜é‡ï¼Œå®ƒçš„ç”Ÿå‘½å‘¨æœŸå—åˆ°ä½œç”¨åŸŸçš„é™åˆ¶ï¼Œå¤§å®¶åŠ¡å¿…ä¸è¦ææ··äº†

å…³äº`T:'static`:

åœ¨ã€ŠRust Courseã€‹4.1.2ä¸‹é¢çš„è¯„è®ºåŒºä¸­æœ‰ä¸€ä¸ªè€å“¥æ„Ÿè§‰è¯´çš„æ¯”è¾ƒå¥½ï¼Œä¸‹é¢æ˜¯è¿™ä½è€å“¥çš„åŸè¯ã€‚

çœ‹äº†ä¸€åœˆæ„Ÿè§‰è¿˜æ˜¯è€å“¥æ¯”è¾ƒé è°±, æ¯•ç«Ÿ ç”Ÿå‘½å‘¨æœŸ å°±æ˜¯é˜²æ­¢å‡ºç° å‚æ‚¬æŒ‡é’ˆ/å‚æ‚¬å¼•ç”¨ å®ç°çš„, å¦‚æœè¾“å…¥ä¸æ˜¯å¼•ç”¨, é‚£æ£€æŸ¥å®ƒçš„ç”Ÿå‘½å‘¨æœŸæœ‰å•¥æ„ä¹‰?

æŒ‰å±‚ä¸»è€å“¥è§£é‡Š,Â `T: 'static`Â ä¸ºÂ `T`Â æ¶‰åŠå¼•ç”¨æ—¶çš„é¢å¤–é™åˆ¶æ¡ä»¶, é‚£å°±è¯´å¾—é€šäº†

- æ³›å‹Â `T`Â ä¸æ¶‰åŠå¼•ç”¨ç±»å‹, é‚£Â `'static`Â é™åˆ¶å¤±æ•ˆ
- æ³›å‹Â `T`Â æ¶‰åŠå¼•ç”¨ç±»å‹, é‚£è¯¥å¼•ç”¨æŒ‡å‘çš„æ•°æ®å¿…é¡»è·å¾—è¶³å¤Ÿä¹…:Â `'static`

æŒ‰è¿™ä¸ªæ€è·¯ç†ä¸€ä¸‹è¿™å‡ ä¸ªç¤ºä¾‹ä»£ç :

```
use std::fmt::Debug;

// æˆ‘ä»¬ä¼ å…¥å¼•ç”¨, é‚£æ­¤æ—¶è¡¨ç¤ºå¼•ç”¨çš„åŸå€¼æ˜¯ 'static çš„å³å¯äº†, è§£å†³æŠ¥é”™
fn print_it<T: Debug + 'static>( input: &T) {
    println!( "'static value passed in is: {:?}", input );
}

fn print_it1( input: impl Debug + 'static ) {
    println!( "'static value passed in is: {:?}", input );
}

fn main() {
    let i = 5;

    // ä¸‹é¢ä¸‰ä¸ªéƒ½ä¸ä¼šæŠ¥é”™
    print_it(&i);
	print_it1(i);
    print_it1(&5);
}
```

1. `print_it`Â è¦æ±‚Â `T`ä¸ºå¼•ç”¨æ—¶, å¼•ç”¨çš„æ•°æ®å¾—æ˜¯`'static`çš„, ä¼ å…¥å‚æ•°æ˜¯`&T`.
    1. æˆ‘ä»¬è¾“å…¥`&i`, æ ¹æ®æ¨¡å¼åŒ¹é…é‚£ä¸ªåŸç†, ä¸¤ä¸ª`&`åŒ¹é…ç›¸å½“äºè§£å¼•ç”¨,Â `T`ä»£è¡¨çš„å°±æ˜¯`i`çš„ç±»å‹`i32`, ä¸æ˜¯å¼•ç”¨ç±»å‹,Â `'static`Â é™åˆ¶å¤±æ•ˆ, ç¼–è¯‘é€šè¿‡
2. `print_it1`Â ä¹Ÿè¦æ±‚Â `T`ä¸ºå¼•ç”¨æ—¶, å¼•ç”¨çš„æ•°æ®å¾—æ˜¯`'static`çš„, ä½†ä¼ å…¥å‚æ•°æ˜¯`T`.
    1. æˆ‘ä»¬è¾“å…¥`i`,Â `T`ä»£è¡¨çš„ä¹Ÿæ˜¯`i`çš„ç±»å‹`i32`, ä¸æ˜¯å¼•ç”¨ç±»å‹,Â `'static`Â é™åˆ¶å¤±æ•ˆ, ç¼–è¯‘é€šè¿‡
    2. æˆ‘ä»¬è¾“å…¥`&5`, æ˜¯ä¸€ä¸ªåˆ‡å®çš„æ•°æ®(å¸¸é‡(`const`)), ç±»å‹æ˜¯å¼•ç”¨ç±»å‹, ç”Ÿå‘½å‘¨æœŸæ˜¯Â `'static`, ç¼–è¯‘é€šè¿‡

---

```
use std::fmt::Debug;
fn print_it<T: Debug + 'static>( input: &T) {
	println!( "'static value passed in is: {:?}", input );
}

fn main(){
    let string = "string".to_string();
    print_it(&string);
    println!("{}",string);
}
```

`print_it`Â è¦æ±‚ä¼ å‚Â `&T`Â , å®é™…ä¼ å‚Â `&String`, è§£å¼•ç”¨åÂ `T`è¡¨ç¤º`String`, ä¸æ˜¯å¼•ç”¨ç±»å‹, å› æ­¤ç¼–è¯‘é€šè¿‡

---

```
use std::fmt::Debug;
fn print_it<T: Debug + 'static>( input: &T) {
	println!( "'static value passed in is: {:?}", input );
}

fn main(){
    let stk = vec![1, 2, 3];
    print_it(&stk);
    println!("{:?}",stk);
}
```

`print_it`Â è¦æ±‚ä¼ å‚Â `&T`Â , å®é™…ä¼ å‚Â `&Vec<_>`, è§£å¼•ç”¨åÂ `T`è¡¨ç¤º`Vec<_>`, ä¸æ˜¯å¼•ç”¨ç±»å‹, å› æ­¤ç¼–è¯‘é€šè¿‡

---

```
use std::fmt::Debug;

#[derive(Debug)]struct Test<'a> {
    a: i32,
    b: &'a i32,
}

fn print_it<T: Debug + 'static>(input: &T) {
    println!("'static value passed in is: {:?}", input);
}
fn main() {
    let n = 3;
    let t = Test {a: 3, b: &n};
    print_it(&t);
}
```

`print_it`Â è¦æ±‚ä¼ å‚Â `&T`Â , å®é™…ä¼ å‚Â `&Test<'a>`, è§£å¼•ç”¨åÂ `T`è¡¨ç¤º`Test<'a>`, ä½†`Test`ç»“æ„ä½“æ¶‰åŠå¼•ç”¨å’Œç”Ÿå‘½å‘¨æœŸçº¦æŸ, å› æ­¤, è¦æƒ³é€šè¿‡ç¼–è¯‘,Â `'a`Â è¿™ä¸ªç”Ÿå‘½å‘¨æœŸå¿…é¡»ä¸ºå¤§äºç­‰äº`'static`. å¾ˆæ˜¾ç„¶`&n`ä¹Ÿå°±æ˜¯`n`çš„ç”Ÿå‘½å‘¨æœŸåœ¨`main()`å‡½æ•°è¿è¡Œç»“æŸå°±é‡Šæ”¾(`drop`), å› æ­¤ç”Ÿå‘½å‘¨æœŸä¸æ˜¯`'static`. ç¼–è¯‘å¤±è´¥

å¦‚ä½•æ‰èƒ½ç¼–è¯‘é€šè¿‡? é‚£ä¹ˆç»™`Test`ä¸€ä¸ª`'static`çš„`i32`å°±å¥½å•¦

```rust
use std::fmt::Debug;

#[derive(Debug)]struct Test<'a> {
    a: i32,
    b: &'a i32,
}

fn print_it<T: Debug + 'static>(input: &T) {
    println!("'static value passed in is: {:?}", input);
}
fn main() {
    const N: i32 = 3;  // const ç”Ÿå‘½å‘¨æœŸæ˜¯ 'static, æ­¤æ—¶'a=='static, é€šè¿‡
    let t = Test {a: 3, b: &N};
    print_it(&t);
}
```